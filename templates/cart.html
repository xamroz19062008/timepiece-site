{% load static %}
<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <title>Корзина — TIMEPIECE</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{% static 'style.css' %}" />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
  </head>
  <body>
    <header class="header glass-panel">
      <div class="container header-inner">
        <a href="/" class="logo">TIMEPIECE</a>

        <nav class="nav">
          <a href="/catalog/">Каталог</a>
          <a href="/cart/">Корзина</a>
        </nav>

        <div class="auth-links">
          {% if user.is_authenticated %}
          <a href="/account/">Аккаунт</a>
          <a href="{% url 'logout' %}">Выйти</a>
          {% else %}
          <a href="{% url 'login' %}">Войти</a>
          <a href="{% url 'signup' %}">Регистрация</a>
          {% endif %}
        </div>
      </div>
    </header>

    <main class="section">
      <div class="container">
        <div
          class="glass-panel"
          style="padding: 32px; max-width: 960px; margin: 0 auto"
        >
          <h1 class="section-title" style="margin-bottom: 24px">Корзина</h1>

          {% if errors.cart %}
          <div class="form-error-global">{{ errors.cart }}</div>
          {% endif %} {% if cart %}
          <div class="cart-block">
            <table class="cart-table">
              <thead>
                <tr>
                  <th>Модель</th>
                  <th>Цена</th>
                  <th>Количество</th>
                  <th>Итого</th>
                  <th></th>
                </tr>
              </thead>

              <tbody>
                {% for item in cart %}
                <tr>
                  <td>
                    <div style="display: flex; gap: 12px; align-items: center">
                      {% if item.watch.image %}
                      <img
                        src="{{ item.watch.image.url }}"
                        alt="{{ item.watch.name }}"
                        style="
                          width: 52px;
                          height: 52px;
                          object-fit: cover;
                          border-radius: 12px;
                        "
                      />
                      {% endif %}
                      <div style="display: flex; flex-direction: column">
                        <div>{{ item.watch.name }}</div>
                      </div>
                    </div>
                  </td>

                  <td>{{ item.price }} сум</td>

                  <td>
                    <form
                      method="post"
                      action="{% url 'cart_add' item.watch.id %}"
                      class="qty-form"
                      data-remove-url="{% url 'cart_remove' item.watch.id %}"
                    >
                      {% csrf_token %}
                      <div class="qty-control">
                        <button
                          type="button"
                          class="qty-btn"
                          data-dir="-"
                          aria-label="Уменьшить"
                        >
                          −
                        </button>

                        <input
                          type="number"
                          name="quantity"
                          value="{{ item.quantity }}"
                          min="1"
                          class="qty-input"
                        />

                        <button
                          type="button"
                          class="qty-btn"
                          data-dir="+"
                          aria-label="Увеличить"
                        >
                          +
                        </button>
                      </div>

                      <input type="hidden" name="update" value="1" />
                    </form>
                  </td>

                  <td>{{ item.total_price }} сум</td>

                  <td>
                    <a href="{% url 'cart_remove' item.watch.id %}" class="link"
                      >Удалить</a
                    >
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>

            <div class="cart-total mono" style="margin-top: 16px">
              Сумма заказа: {{ cart.get_total_price }} сум
            </div>
          </div>

          <div class="checkout-block" style="margin-top: 40px">
            <h2
              class="section-title"
              style="font-size: 24px; margin-bottom: 12px"
            >
              Оформление
            </h2>

            {% if errors.location or errors.phone or errors.map %}
            <div class="form-error-global">
              Пожалуйста, заполните все поля и выберите точку на карте.
            </div>
            {% endif %}

            <form
              method="post"
              action="{% url 'checkout' %}"
              class="checkout-form"
            >
              {% csrf_token %}

              <div class="form-row" style="margin-bottom: 16px">
                <label
                  for="id_location"
                  style="display: block; margin-bottom: 4px"
                >
                  Локация (адрес текстом):
                </label>
                <input
                  type="text"
                  name="location"
                  id="id_location"
                  value="{{ form.location|default_if_none:'' }}"
                  required
                  style="
                    width: 100%;
                    max-width: 480px;
                    padding: 8px 12px;
                    border-radius: 8px;
                    border: none;
                  "
                />
                {% if errors.location %}
                <p class="field-error">{{ errors.location }}</p>
                {% endif %}
              </div>

              <div class="form-row" style="margin-bottom: 24px">
                <label
                  for="id_phone"
                  style="display: block; margin-bottom: 4px"
                >
                  Телефон:
                </label>
                <input
                  type="text"
                  name="phone"
                  id="id_phone"
                  value="{{ form.phone|default_if_none:'' }}"
                  required
                  style="
                    width: 100%;
                    max-width: 240px;
                    padding: 8px 12px;
                    border-radius: 8px;
                    border: none;
                  "
                />
                {% if errors.phone %}
                <p class="field-error">{{ errors.phone }}</p>
                {% endif %}
              </div>

              <div class="form-row">
                <h3
                  class="section-title"
                  style="font-size: 20px; margin-bottom: 4px"
                >
                  Выберите точку на карте
                </h3>
                <p class="mono" style="margin-bottom: 8px">
                  Кликните по карте, чтобы указать место доставки.
                </p>

                <div
                  id="map"
                  style="
                    width: 100%;
                    height: 320px;
                    margin-top: 8px;
                    border-radius: 16px;
                    overflow: hidden;
                  "
                ></div>

                {% if errors.map %}
                <p class="field-error">{{ errors.map }}</p>
                {% endif %}

                <input
                  type="hidden"
                  name="latitude"
                  id="id_latitude"
                  value="{{ form.latitude|default_if_none:'' }}"
                />
                <input
                  type="hidden"
                  name="longitude"
                  id="id_longitude"
                  value="{{ form.longitude|default_if_none:'' }}"
                />
              </div>

              <div style="margin-top: 24px">
                <button
                  type="submit"
                  id="checkout-submit"
                  class="btn btn-primary"
                >
                  ПЕРЕЙТИ К ОПЛАТЕ
                </button>
              </div>
            </form>
          </div>

          {% else %}
          <p>Ваша корзина пуста.</p>
          {% endif %}
        </div>
      </div>
    </main>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // ===== MAP =====
        var map = L.map("map").setView([41.3111, 69.2797], 12);
        var marker = null;

        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "&copy; OpenStreetMap contributors",
        }).addTo(map);

        var latInput = document.getElementById("id_latitude");
        var lngInput = document.getElementById("id_longitude");
        var locationInput = document.getElementById("id_location");
        var phoneInput = document.getElementById("id_phone");
        var submitBtn = document.getElementById("checkout-submit");

        function setMarker(lat, lng) {
          if (marker) {
            marker.setLatLng([lat, lng]);
          } else {
            marker = L.marker([lat, lng]).addTo(map);
          }
          latInput.value = lat;
          lngInput.value = lng;
          updateSubmitState();
        }

        map.on("click", function (e) {
          var lat = e.latlng.lat.toFixed(6);
          var lng = e.latlng.lng.toFixed(6);
          setMarker(lat, lng);
        });

        function updateSubmitState() {
          var hasLocation = locationInput.value.trim().length > 0;
          var hasPhone = phoneInput.value.trim().length > 0;
          var hasCoords = latInput.value && lngInput.value;
          submitBtn.disabled = !(hasLocation && hasPhone && hasCoords);
        }

        if (locationInput)
          locationInput.addEventListener("input", updateSubmitState);
        if (phoneInput) phoneInput.addEventListener("input", updateSubmitState);

        if (latInput.value && lngInput.value) {
          setMarker(parseFloat(latInput.value), parseFloat(lngInput.value));
        }

        updateSubmitState();

        // ===== QTY +/-  (минус при 1 -> удалить) =====
        document.querySelectorAll(".qty-form").forEach(function (form) {
          var input = form.querySelector(".qty-input");
          var minus = form.querySelector('.qty-btn[data-dir="-"]');
          var plus = form.querySelector('.qty-btn[data-dir="+"]');
          var removeUrl = form.getAttribute("data-remove-url");

          function submitWithValue(val) {
            input.value = val;
            form.submit();
          }

          minus.addEventListener("click", function (e) {
            e.preventDefault();
            var current = parseInt(input.value || "1", 10);

            // ✅ если было 1 — удаляем товар полностью
            if (current <= 1) {
              window.location.href = removeUrl;
              return;
            }

            submitWithValue(current - 1);
          });

          plus.addEventListener("click", function (e) {
            e.preventDefault();
            var current = parseInt(input.value || "1", 10);
            submitWithValue(current + 1);
          });
        });
      });
    </script>
  </body>
</html>
